(function($){$.fn.bbcode=function(tag){var scrollTop,scrollLeft,field=$(this)[0],is_mozilla=navigator.userAgent.toLowerCase().indexOf("gecko")>0,is_ie=navigator.userAgent.toLowerCase().indexOf("msie")>0,selection=!1;if(is_mozilla&&(scrollTop=field.scrollTop,scrollLeft=field.scrollLeft,selection=field.value.substring(field.selectionStart,field.selectionEnd)),is_ie&&document.selection){var range=document.selection.createRange(),stored_range=range.duplicate();""!=range.text?(stored_range.moveToElementText(field),stored_range.setEndPoint("EndToEnd",range),field.selectionStart=stored_range.text.length-range.text.length,field.selectionEnd=field.selectionStart+range.text.length):(field.selectionStart=field.value.length+15,field.selectionEnd=field.value.length+15)}var start=field.selectionStart,end=field.selectionEnd;selection===!1&&document.selection&&(selection=document.selection.createRange().text),selection===!1&&window.getSelection&&(selection=window.getSelection()),selection===!1&&document.getSelection&&(selection=document.getSelection()),selection===!1&&(selection="");var text=field.value,pre=text.substring(0,start),post=text.substring(end);if("url"==tag){var url=prompt("url:");if(!url)return;text=pre+"[url="+url+"]"+selection+"[/url]"+post,tag=url+tag+1}else if("img"==tag){if(""==selection&&(selection=prompt("url:")),!selection)return;text=pre+"[img]"+selection+"[/img]"+post}else"color"==tag?(text=pre+"[color="+arguments[1]+"]"+selection+"[/color]"+post,tag="color="+arguments[1]):text=pre+"["+tag+"]"+selection+"[/"+tag+"]"+post;field.value=text,is_ie||(field.selectionStart=start+tag.length+2,field.selectionEnd=start+(tag.length+2)+selection.length),is_mozilla&&(field.scrollTop=scrollTop,field.scrollLeft=scrollLeft),field.focus()}})(jQuery);